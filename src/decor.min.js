// DecorJS - v0.4 | https://github.com/Q42/DecorJS | (c) 2014 Q42, Marcel Duin <marcel@q42.nl> | MIT Licensed, https://github.com/Q42/DecorJS/blob/master/LICENSE
if(!window.$){$=function(a){return new _$(a)};$.extend=function(){function a(c,f){for(var d in c){var h=c[d],l=h.constructor;f[d]=!b||l!=Array&&l!=Object?!b||l!=Number&&l!=String?h:l(h):a(h,new l)}return f}for(var c=arguments,b=!0===c[0],d=c[b&&1||0],f=b?2:1;f<c.length;f++)a(c[f],d);return d};$.inArray=function(a,c){return c.indexOf(a)};var _getEls=function(a,c){if(a==window)return[window];if(a instanceof Element)return[a];if(a instanceof Array||a instanceof _$)return a;if(/^\</.test(a)){var b=document.createElement("div");
b.innerHTML=a;return b.childNodes}return a?(c||document).querySelectorAll(a):[]},_$=function(a,c){var b=_getEls(a,c),d;for(d in b)this[d]=b[d];this.length||(this.length=b.length)};_$.prototype={each:function(a){for(var c=0;c<this.length;c++)a.call(this[c]);return this},remove:function(){this.each(function(){this.parentNode.removeChild(this)});return this},replaceWith:function(a){var c=this;c[0]&&(a.each?a.each(function(){c[0].parentNode.insertBefore(this,c[0])}):c[0].parentNode.insertBefore(a,c[0]),
c.remove());return this},appendTo:function(a){a=a.length?a[0]:a;this.each(function(){a.appendChild(this)});return this},parent:function(){var a=[];this.each(function(){a.push(this.parentNode)});return new _$(a)},children:function(a){a=a||"*";var c=[];this.each(function(){for(var b=this.querySelectorAll(a),d=0;d<b.length;d++)b[d].parentNode==this&&c.push(b[d])});return new _$(c)},find:function(a){return new _$(a,this[0])},filter:function(a,c){a=_getEls(a);return new _$([].filter.call(this,function(b){for(var d=
0;d<a.length;d++)if(all[d]==b)return!c;return!!c}))},not:function(a){return this.filter(a,!0)},eq:function(a){return new _$(this[a])},has:function(a){for(var c=0;c<this.length;c++)if(this[c]==a)return!0},add:function(a){a=_getEls(a);for(var c=this,b=[],d=0;d<this.length;d++)b.push(this[d]);a=b.concat([].filter.call(a,function(a){return!c.has(a)}));return a.length==this.length?this:new _$(a)},attr:function(a,c){if(void 0===c)return this[0]&&this[0].getAttribute(a);this.each(function(){this[(null===
c?"remove":"set")+"Attribute"](a,c)});return this},trigger:function(a,c){this.each(function(){this.dispatchEvent(new CustomEvent(a,{detail:c}))});return this},on:function(a,c){this.each(function(){this.addEventListener(a,c)});return this},off:function(a,c){this.each(function(){this.removeEventListener(a,c)});return this},click:function(a){if(a instanceof Function)this.on("click",a);else this.trigger("click");return this},text:function(a){if(void 0===a)return this[0]&&this[0].innerText;this.each(function(){this.innerText=
a});return this},html:function(a){if(void 0===t)return this[0]&&this[0].innerHTML;this.each(function(){this.innerHTML=a});return this},hasClass:function(a,c){c=0;this.each(function(){c+=this.classList.contains(a)&&1||0});return!!c},addClass:function(a){a=a.split(" ");this.each(function(){for(var c in a)this.classList.add(a[c])});return this},removeClass:function(a){a=a.split(" ");this.each(function(){for(var c in a)this.classList.remove(a[c])});return this},toggleClass:function(a){a=a.split(" ");
for(var c in a)this[(this.hasClass(a[c])?"remove":"add")+"Class"](a[c]);return this},setcss:function(a,c){this.each(function(){this.style.setProperty(a,c)});return this},getcss:function(a){return this[0]&&this[0].style.getPropertyValue(a)},css:function(a,c){if("string"==typeof a){if(void 0===c)return this.getcss(a);this.setcss(a,c)}else for(var b in a)this.setcss(b,a[b]);return this},hide:function(){this.setcss("display","none");return this},show:function(){this.setcss("display",null);return this},
width:function(){return this[0]&&this[0].clientWidth},height:function(){return this[0]&&this[0].clientHeight}}}
Decor=new function(){function a(){document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);removeEventListener("touchstart",a)}var c=this,b=navigator.userAgent.toLowerCase();isWebkit=/chrome/.test(b);isFirefox=/firefox/.test(b);isIE=/msie/.test(b)||/trident/.test(b);isIOS=/ipad|iphone|ipod/.test(b);isAndroid=/android/.test(b);isMobile=isIOS||isAndroid;c3p=isWebkit||isIOS?"-webkit-":"";c3={transform:c3p+"transform",transition:c3p+"transition",animation:c3p+"animation"};c3d={transform:(isWebkit||
isIOS?"webkitT":"t")+"ransform",transition:(isWebkit||isIOS?"webkitT":"t")+"ransition",animation:(isWebkit||isIOS?"webkitA":"a")+"animation"};$window=$(window);var d={};this.Scenes={};this.Things={};this.reloadScene=function(){c.resetTo(Decor.currentScene.name)()};this.reset=function(){var a=null,b;for(b in Decor.Scenes){a=b;break}c.resetTo(a)()};this.resetTo=function(a){return function(){Decor.currentScene&&Decor.currentScene.hide(function(){localStorage.removeItem("currentScene");Decor.currentScene=
null;for(var b in d)c.delete(b);c.goto(a)()})}};this.resetHard=function(){localStorage.removeItem("currentScene");Decor.currentScene?Decor.currentScene.hide(function(){location.reload()}):location.reload()};this.goto=function(a){return function(b){function c(){(d[a]||(d[a]=new Decor.Scene(a,h))).show()}var e=Decor.currentScene;if(!e||e.name!=a){b&&b.target&&(b.stopPropagation(),b.preventDefault());var h=Decor.Scenes[a];if(!h)return console.error("Scene ["+a+"] not found");e?e.hide(c):c()}}};this.delete=
function(a){function b(){delete d[a]}d[a]&&(d[a].deleted?b():d[a].delete(b))};isMobile&&($("html").addClass("mobile"+(isAndroid?" android":"")),addEventListener("touchstart",a))};
Decor.Scene=function(a,c){function b(){if(!q){q=!0;e.$[0].scrollLeft=0;f();for(var a=0;a<c.objects.length;a++){var b=c.objects[a];if(!(b.o&&b.o.noIE&&isIE)){var g,l;for(l in b){g=l;break}b.o&&b.o.img&&r++;var k=Decor.Things[g];if(k){var h=e,n=b[g],m=b.o,m=m||{};m.dims=m.dims||[1,1];m.pos=m.pos||[0,0,0];m.rot=m.rot||[0,0,0];k=new k(h,n,m);k.name=b[g];e.objects.push(k)}else console.warn("Object type "+g+" not found")}}if(c.oninit)c.oninit(e);r||d()}}function d(){e.$.addClass("loaded animate");e.show();
c.scrollLeft&&setTimeout(function(){e.$[0].scrollLeft=Math.round(10*e.width*c.scrollLeft)})}function f(){clearTimeout(p);p=setTimeout(g,20);e.$.addClass("resizing");m||(m=e.$[0].scrollLeft/e.$[0].scrollWidth);var a=[innerWidth,innerWidth/h];a[1]>innerHeight&&(a=[innerHeight*h,innerHeight]);var b={"margin-left":e.margin[0]=c.fullWidth?0:Math.round((innerWidth-a[0])/2),"margin-top":e.margin[1]=Math.round((innerHeight-a[1])/2)};c.fixedSize&&c.res?e.$.css(c3.transform,"scale("+(e.scale=a[0]/l[0])+")"):
(e.width=Math.round(a[0]),b.width=c.fullWidth?innerWidth:e.width,b.height=e.height=Math.round(a[1]));e.$.css(b).trigger("scene-resize")}function g(){e.$.removeClass("resizing");m&&(e.$[0].scrollLeft=Math.round(m*e.$[0].scrollWidth));m=0}function n(a){for(var b in e.objects)e.objects[b].destroy&&e.objects[b].destroy();e.$.remove();delete e.$;e.deleted=!0;a&&a()}c=$.extend(!0,{},c);var e=this,h=16/9,l=c.res||[innerWidth,innerHeight*h],k=!1,q=!1,r=0,m=0,p=null;c.width=c.width||1;c.height=c.height||1;
this.name=a;this.data=c;this.width=l[0];this.height=l[1];this.scale=1;this.objects=[];this.collisionObjects=[];this.margin=[0,0];this.camera=new Decor.Camera(this);this.deleted=this.active=!1;this.$=$("<scene>").addClass(a).css({width:l[0],height:l[1]}).appendTo(document.body);c.scrolling&&1<c.width&&$('<div class="canvas">').css("width",100*c.width+"%").appendTo(this.$);this.imageLoaded=function(){--r||d()};this.addLoadImage=function(){r++};this.getThing=function(a){for(var b in e.objects)if(e.objects[b].name==
a)return e.objects[b]};this.show=function(){if(!k){if(q)f();else return b();Decor.currentScene&&Decor.delete(Decor.currentScene.name);Decor.currentScene=this;localStorage.setItem("currentScene",a);e.$.addClass("placed");k=!0;e.active=!0;addEventListener("resize",f);c.audio&&Decor.Audio.play(c.audio.src,c.audio);e.$.trigger("scene-show",a);setTimeout(function(){e.$.addClass("shown");$(document.body).addClass("scene-shown")})}};this.hide=function(b){if(!k)return b&&b();k=!1;e.active=!1;e.$.removeClass("shown");
$(document.body).removeClass("scene-shown");$window.add(e.$).trigger("scene-hide",a);removeEventListener("resize",f);c.audio&&Decor.Audio.stop(c.audio.src);setTimeout(function(){e.$.removeClass("placed");b&&b()},1E3)};this.delete=function(a){k?e.hide(function(){n(a)}):n(a)}};
Decor.Camera=function(a){function c(c){var d={l:b.position[0]-1,r:b.position[0]+2,t:b.position[1]-0.5,b:b.position[1]+1},e;for(e in a.objects){var f=a.objects[e];f.matrix&&(f.attr.main||(a.data.renderAll||f.matrix.intersects(d))&&c&&c.call(f))}}var b=this,d=a.data.height-1,f="0,0,0";this.offset=[0,d,0];this.position=[0,0,0];this.setPosition=function(a,n){var e=a+"";f!=e&&(f=e,b.position[0]=Math.max(0,a[0]),b.position[1]=Math.min(d,Math.max(0,a[1])),b.position[2]=-a[2],c(function(){this.place(n)}))};
this.reset=function(){b.setPosition([0,0,0],!0)}};
Decor.Object3D=function(a,c,b){var d=this;this.matrix=new Decor.Mat3D(this,b.pos,b.rot,b.scale);this.notInView=!1;this.reset=function(){d.matrix.translate(null,!0);return d};this.setPosition=function(a){b.pos[0]=a[0];b.pos[1]=-a[1];b.pos[2]=a[2];d.reset().place()};this.translate=function(a,b){d.matrix.translate(a);d.place();return d};this.setNotInView=function(a){d.notInView!=a&&((d.notInView=a)?c.hide():c.show())};this.place=function(a){c[0].style[c3d.transform]=d.matrix.getCSS(a)};this.focus=function(){if(a.dimmed&&
c.hasClass("open"))return $(".nav.back").click();var f="zoomout";if(c.toggleClass("open").hasClass("open")){f="zoomin";a.$.find(".open").not(c).removeClass("open");var g=d.matrix.getPosition(),n=d.$.width(),e=d.$.height();e>a.height?g[2]-=a.height-e:n>a.width&&(g[2]-=(a.width-n)/3);g[0]-=(1-b.width)/2;a.camera.setPosition(g)}else a.camera.reset();a.$.trigger(f,d.name)};this.place();a.$.on("scene-resize",d.place)};
Decor.Mat3D=function(a,c,b,d){c=c||[0,0,0];b=b||[0,0,0];d=d?d.length?d:[d||1,d||1]:[1,1];var f=this,g=a.scene,n=g.camera.position,e=[0,0,0],h=[a.rwidth,a.rheight];this.getQuad=function(a){a=a||[0,0,0];var b=f.getPosition();return{l:b[0]+a[0],r:b[0]+a[0]+h[0],t:-(b[1]-a[1]),b:-(b[1]-a[1]-h[1])}};this.intersects=function(a){var b=f.getQuad();return!(a.l>b.r||a.r<b.l||a.t>b.b||a.b<b.t)};this.getCSS=function(f){var k=a.scene.camera.offset,h=a.attr.relative?0:n[0],r=a.attr.relative?0:k[1]-(g.data.height-
1)-n[1],m=[g.width,g.height],p=[];f||(h-=g.$[0].scrollLeft/g.width);f=[Math.round(m[0]*(c[0]+e[0]+k[0]-h)),-Math.round(m[1]*(c[1]+e[1]+r)),Math.round(0.3*(c[2]+e[2]+n[2]))+k[2]];p.push("translate3d("+f.join("px,")+"px)");b[0]&&p.push("rotateX("+b[0]+"deg)");b[1]&&p.push("rotateY("+b[1]+"deg)");b[2]&&p.push("rotateZ("+b[2]+"deg)");"1,1"!=String(d)&&p.push("scale3d("+d.join(",")+",1)");return p.join(" ")};this.getPosition=function(a){return[c[0]+e[0],-(c[1]+e[1]),c[2]+e[2]]};this.getElementPosition=
function(){var b=f.getPosition(),c=getComputedStyle(a.$[0])[c3.transform];/^matrix\(/.test(c)&&(c=c.substr(0,c.length-1).split(","),b[0]+=parseFloat(c[4])/g.width,b[1]+=parseFloat(c[5])/g.height);return b};this.getX=function(){return c[0]+e[0]};this.getY=function(){return c[1]+e[1]};this.getZ=function(){return c[2]+e[2]+n[2]};this.translate=function(a,b){b&&(e=[0,0,0]);a&&(e[0]+=a[0],e[1]+=a[1],e[2]+=a[2]);return f}};
Decor.Frame=new function(){function a(f){if(c.length){for(var g=0;g<c.length;g++)c.shift()(f);d=requestAnimationFrame(a)}else b&&(b=!1,cancelAnimationFrame(d))}var c=[],b=!1,d=null;this.request=function(f){1==c.push(f)&&(b||(b=!0,d=requestAnimationFrame(a)))};this.cancel=function(a){for(var g=0;g<c.length;g++)a==c[g]&&c.shift();!c.length&&b&&(b=!1,cancelAnimationFrame(d))}};
Decor.Audio=new function(){function a(a,b){b=b||{};this.audio=new Audio;this.audio.volume=b.volume||1;this.audio.src=this.src=a;this.play()}function c(a){isIE&&/\.ogg$/.test(a)&&(a=a.replace(/\.ogg/,".mp3"));return a}var b=[];a.prototype={playing:!1,play:function(){this.audio&&!this.playing&&(this.playing=!0,this.audio.load(),this.audio.play(),this.audio.addEventListener("ended",this.stop))},stop:function(){this.playing&&(this.playing=!1,this.audio.pause())}};this.play=function(d,f){d=c(d);var g;
a:{for(g in b)if(b[g].src==d&&!b[g].playing){g=b[g];break a}g=void 0}g?g.play.call(g):b.push(g=new a(d,f));return g.audio};this.stop=function(a){a=c(a);for(var f in b)b[f].src==a&&b[f].stop.call(b[f])}};
Decor.Things.Thing=function(a,c,b){var d=this;this.attr=b;this.scene=a;var f=$(b.static?"<thing>":"<dud>");f[0].thing=this;this.$cnt=f;c&&f.addClass(c+(b.static?" static":"")+(b.class?" "+b.class:""));this.$=b.static?f:$("<thing>").appendTo(f);b.innerText&&this.$.text(b.innerText);this.setDims=function(){var c=b.isDepth?a.height/1080:1;d.$.css({width:d.width=b.px&&b.px[0]||Math.round(b.dims[0]*a.width),height:d.height=b.px&&b.px[1]||100*(b.dims[1]/c)+"%"});d.rwidth=b.px?b.px[0]/a.width:b.dims[0];
d.rheight=b.px?b.px[1]/a.height:b.dims[1]};a.$.on("scene-resize",this.setDims);this.setDims();this.show=function(){f.appendTo(a.$)};this.hide=function(){f.remove()};Decor.Object3D.call(this,a,f,b);b.noshow||this.show()};Decor.Things.Static=function(a,c,b){b.static=!0;Decor.Things.Thing.call(this,a,c,b)};Decor.Things.Image=function(a,c,b){b.static=!0;Decor.Things.ImageContain.call(this,a,c,b)};
Decor.Things.ImageContain=function(a,c,b){function d(){var a=h.height*e.width()/h.width,b=Math.round(a*q[0][1]);l.css({height:a-b,bottom:b})}b.width=b.width||1;b.dims=[b.width,0];var f=this,g=/\..{3}$/.test(b.img)?"":".png",g="img/"+b.img+g,n=b.px?b.px[0]:100*b.dims[0]+"%",e=$("<dud>").css("width",n).appendTo(a.$);b.class&&e.addClass(b.class);this.attr=b;this.scene=a;var h=null,h=new Image;h.thing=f;h.onload=function(g){b.dims[1]=b.dims[0]*h.height/h.width;f.rwidth=b.dims[0];f.rheight=b.dims[1];k&&
d();f.$.addClass("image "+c);b.static&&(f.$.css("width",n),f.$cnt.replaceWith(f.$),e=f.$);Decor.Object3D.call(f,a,e,b);b.clickable&&(k?l:f.$).click(f.focus);b.static||f.$.appendTo(f.$cnt);if(f.onload)f.onload();a.imageLoaded(c)};h.onerror=a.imageLoaded;h.src=g;f.$=$(h);f.$cnt=e;e[0].thing=this;var l=$(),k=b.clickable&&b.clickable.length,q=b.clickable&&b.clickable.length?b.clickable:[[0,0],[1,1]];b.clickable&&(e.addClass("clickable"),k&&(e.addClass("has-area"),l=$('<div class="click">').css({left:100*
q[0][0]+"%",width:100*(q[1][0]-q[0][0])+"%"}).appendTo(e)));if(k)a.$.on("scene-resize",d)};Decor.Things.ImageRep=function(a,c,b){a.imageLoaded();for(var d=0;d<b.repeat;d++)a.addLoadImage(),a.objects.push(new Decor.Things.Image(a,c,{img:b.img,width:b.width,pos:[b.pos[0]+d*b.width,b.pos[1],b.pos[2]]}))};
